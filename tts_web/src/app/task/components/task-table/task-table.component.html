<ngx-spinner bdColor="rgba(51,51,51,0.8)" size="medium" color="#fff" type="ball-scale-multiple" [fullScreen]="true">
    <p class="info" style="color: white ; font-size: 40px; text-align: 700px;">Loading</p>
</ngx-spinner>



<div class="taskTable" *ngIf="parentAndAllTask">

  

    <ng-container *ngIf="parentAndAllTask.parentTasks.length>0; else nodata">
        <div class="align-right" style="margin-left: 90%;margin-top: 10px;">
            <span title="Add Task" class="fa-solid fa-circle-plus fa-xl mainaddtaskbtn -mt35px" style="color: #03a300; transform: scale(1.5);"
                data-bs-toggle="modal" attr.data-bs-target="#createTask{{modalId + 1}}"
                (click)="onClickCreateTask(task, 'ADD', $event)"></span>

        </div>


        <ng-container *ngFor="let parentTaskData of parentAndAllTask.parentTasks; let i = index">
            <ng-container
                *ngIf="(parentTaskData.childTask | statusFilter:filteredStatus | employeeTaskFilter:filteredEmployees).length>0">

          
                <mat-card class="card" style="border: 10px groove cadetblue;" *ngIf="parentTaskData.placementId==1"  (click)="NavigateParentView(parentTaskData.taskId)">
                     
                  
                 
                 
                    <mat-card-content style="text-align: center">

                        <div class="data" *ngIf="parentTaskData.placementId==1">
                            <!-- <h5 style="font-size: 18px;margin-left: 40px;margin-top: 10px;">Bench Candidate</h5> -->
                            <!-- <i class="fa fa-users" style=" transform: scale(3);margin-top: 20px;"  aria-hidden="true"></i> -->
                            <img src="./assets/bench.png"
                             style="width: 15%; height: 15%; border: 2px solid; border-radius: 15px;margin-right: 20px;margin-left:5px;"> 
                        </div>
                        <!-- <div class="data" *ngIf="parentTaskData.placementId==2">
                          
                           <i class="fa fa-user-circle" style="transform: scale(3);margin-top: 20px;"  aria-hidden="true"></i>
                       </div> -->
                        

                        <!-- <img src="{{displayCompanyLogo}}/{{companyId}}"
                            style="width: 90%; height: 120px;"> -->


                        <!-- <span title="Add Task" class="fa-solid fa-circle-plus fa-xl addtask" id="childAddBtn"
                    data-bs-toggle="modal" attr.data-bs-target="#createTask{{modalId + 1}}"
                    (click)="onClickCreateTask(parentTaskData, 'ADD', $event)"></span> -->
                    </mat-card-content>

                    <mat-card-content style="text-align: center">
                        <h1 style="color:purple;word-break:break-all;font-size: 24px;margin-top: 30px;">{{parentTaskData.taskName}}
                        </h1>

                        <!-- <span title="Add Task" class="fa-solid fa-circle-plus fa-xl addtask" id="childAddBtn"
                                data-bs-toggle="modal" attr.data-bs-target="#createTask{{modalId + 1}}"
                                (click)="onClickCreateTask(parentTaskData, 'ADD', $event)"></span> -->
                    </mat-card-content>

                    

                    <mat-card-content id="statusdesc" style="margin-top: 15px;">
                        <ng-container *ngFor="let status of allStatus">
                            <ng-container *ngIf="status.statusId == parentTaskData.taskStatus">

                                <ng-container *ngIf="status.statusCode === 'Created'">
                                    <h5 style="background-color: #03a300;font-size: 18px;color: white;">Status: {{status.statusCode | titlecase}}
                                    </h5>
                                </ng-container>

                                <ng-container *ngIf="status.statusCode === 'In-progress'">
                                    <h5 style="background-color:dodgerblue;font-size: 18px;color: white;">Status: {{status.statusCode | titlecase}}
                                    </h5>
                                </ng-container>

                                <ng-container *ngIf="status.statusCode === 'Cancelled'">
                                    <h5 style="background-color:cyan;font-size: 18px;color: white;">Status: {{status.statusCode | titlecase}}
                                    </h5>
                                </ng-container>

                                <ng-container *ngIf="status.statusCode === 'Done'">
                                    <h5 style="background-color:lightblue;font-size: 18px;color: white;">Status:
                                        {{status.statusCode | titlecase}}
                                    </h5>
                                </ng-container>
                            </ng-container>
                        </ng-container>


                    </mat-card-content>
               
              

                </mat-card>



                <!-- Source Candidate...-->

                <mat-card class="card" style="border: 10px groove dodgerblue;" *ngIf="parentTaskData.placementId==2"  (click)="NavigateParentView(parentTaskData.taskId)">
                     
                  
                 
                 
                    <mat-card-content style="text-align: center">

                        <!-- <div class="data" *ngIf="parentTaskData.placementId==1">
                           
                            <i class="fa fa-users" style=" transform: scale(3);margin-top: 20px;"  aria-hidden="true"></i>
                        </div> -->
                        <div class="data" *ngIf="parentTaskData.placementId==2">
                          
                           <i class="fa fa-user-circle" style="transform: scale(4);margin-top: 20px;"  aria-hidden="true"></i>
                       </div>
                        

                        <!-- <img src="{{displayCompanyLogo}}/{{companyId}}"
                            style="width: 90%; height: 120px;"> -->


                        <!-- <span title="Add Task" class="fa-solid fa-circle-plus fa-xl addtask" id="childAddBtn"
                    data-bs-toggle="modal" attr.data-bs-target="#createTask{{modalId + 1}}"
                    (click)="onClickCreateTask(parentTaskData, 'ADD', $event)"></span> -->
                    </mat-card-content>

                    <mat-card-content style="text-align: center">
                        <h1 style="color:purple;word-break:break-all;font-size: 24px;margin-top: 30px;">{{parentTaskData.taskName}}
                        </h1>

                        <!-- <span title="Add Task" class="fa-solid fa-circle-plus fa-xl addtask" id="childAddBtn"
                                data-bs-toggle="modal" attr.data-bs-target="#createTask{{modalId + 1}}"
                                (click)="onClickCreateTask(parentTaskData, 'ADD', $event)"></span> -->
                    </mat-card-content>

                    

                    <mat-card-content id="statusdesc" style="margin-top: 15px;">
                        <ng-container *ngFor="let status of allStatus">
                            <ng-container *ngIf="status.statusId == parentTaskData.taskStatus">

                                <ng-container *ngIf="status.statusCode === 'Created'">
                                    <h5 style="background-color: #03a300;font-size: 18px;color: white;">Status: {{status.statusCode | titlecase}}
                                    </h5>
                                </ng-container>

                                <ng-container *ngIf="status.statusCode === 'In-progress'">
                                    <h5 style="background-color:dodgerblue;font-size: 18px;color: white;">Status: {{status.statusCode | titlecase}}
                                    </h5>
                                </ng-container>

                                <ng-container *ngIf="status.statusCode === 'Cancelled'">
                                    <h5 style="background-color:cyan;font-size: 18px;color: white;">Status: {{status.statusCode | titlecase}}
                                    </h5>
                                </ng-container>

                                <ng-container *ngIf="status.statusCode === 'Done'">
                                    <h5 style="background-color:lightblue;font-size: 18px;color: white;">Status:
                                        {{status.statusCode | titlecase}}
                                    </h5>
                                </ng-container>
                            </ng-container>
                        </ng-container>


                    </mat-card-content>
               
              

                </mat-card>
           
            </ng-container>
        </ng-container>


        <ng-container *ngFor="let parentTaskData of parentAndAllTask.parentTasks; let i = index">
            <ng-container
                *ngIf="(parentTaskData.childTask | statusFilter:filteredStatus | employeeTaskFilter:filteredEmployees).length>0">

                <!-- called on click function when logged employee is creator -->
                <mat-expansion-panel class="expansionrow" hideToggle="false" (click)="toggleChildTable(parentTaskData)"
                    [expanded]="toggledTasksIds.has(parentTaskData.taskId)">
                    <!-- <mat-expansion-panel-header>
                            <mat-panel-title>
                                <b>{{parentTaskData.taskName}}</b>
                            </mat-panel-title>
                            <mat-panel-description class="align-right">

                                <span title="Add Task" class="fa-solid fa-circle-plus fa-xl addtask"
                                    style="color: #03a300;" data-bs-toggle="modal"
                                    attr.data-bs-target="#createTask{{modalId + 1}}"
                                    (click)="onClickCreateTask(parentTaskData, 'ADD', $event)"></span>

                            </mat-panel-description>
                        </mat-expansion-panel-header> -->
                    <!-- {{task|json}} -->
                    <!-- {{parentAndAllTask|json}} -->
                    <table class="table table-striped table-bordered table-custom-font-size">
                        <thead>
                            <!-- Header Row -->
                            <ng-container *ngTemplateOutlet="headers"></ng-container>
                        </thead>
                        <tbody>

                            <!-- Main Rows with Expandable Child Panels -->
                            <ng-container
                                *ngFor="let childTaskData of parentTaskData.childTask | statusFilter: filteredStatus| employeeTaskFilter:filteredEmployees; let i = index">

                                <!-- if child's parent id and parent id is same OR child's task id and parent task id is same(means it is parent task ) -->
                                <ng-container
                                    *ngIf="childTaskData.taskParent == parentTaskData.taskId || (childTaskData.taskId == parentTaskData.taskId)">
                                    <ng-container
                                        *ngTemplateOutlet="tableRows; context: {$implicit: childTaskData}"></ng-container>
                                </ng-container>
                            </ng-container>

                        </tbody>
                    </table>

                </mat-expansion-panel>
            </ng-container>
        </ng-container>
    </ng-container>
</div>



<ng-template #headers>
    <tr>
        <!-- <th scope="col">Task</th> -->
        <th scope="col" class="col-sm-2">Task Name</th>
        <th scope="col" class="col-sm-2">Description</th>
        <th scope="col" class="col-sm-1.5">Created By</th>
        <th scope="col" class="col-sm-1.5">Assigned To</th>
        <th scope="col">ETC</th>
        <th scope="col">Status</th>
        <th scopr="col">End Date</th>
        <th scope="col">Action</th>
    </tr>
</ng-template>


<ng-template #tableRows let-taskData>


    <ng-container
        *ngIf="taskData.taskParent>0 || (taskData.taskCreatedBy==employeeId || taskData.taskAssignedTo==employeeId || loggedInUserData.showAllTasks == true)">
        <tr [ngClass]="{'table-info':taskData.taskParent==0}" class="col-height">

            <td for="taskName" data-toggle="tooltip" data-placement="right" title="{{taskData.taskName}}">{{
                taskData.taskName | slice:0:20 }} </td>
            <td for="taskDescription" data-toggle="tooltip" data-placement="right" title="{{taskData.taskDescription}}">
                {{
                taskData.taskDescription | slice:0:20 }}
            </td>
            <td>
                <ng-container *ngFor="let employee of employees">
                    <ng-container *ngIf="employee.employeeId == taskData.taskCreatedBy">
                        {{employee.firstName | titlecase}} {{employee.lastName | titlecase}}
                    </ng-container>
                </ng-container>

            </td>
            <td>

                <ng-container *ngFor="let employee of employees">
                    <ng-container *ngIf="employee.employeeId == taskData.taskAssignedTo">
                        {{employee.firstName | titlecase}} {{employee.lastName | titlecase}}
                    </ng-container>
                </ng-container>

            </td>
            <td>{{ taskData.taskEndDate | date: selectedDateFormat}}</td>
            <td>

                <ng-container *ngFor="let status of allStatus">
                    <ng-container *ngIf="status.statusId == taskData.taskStatus">
                        {{status.statusCode | titlecase}}
                    </ng-container>
                </ng-container>

            </td>
            <td>{{taskData.taskActualEndDate | date: selectedDateFormat}}</td>
            <td>
                <div class="row">


                    <div class="col icons" *ngIf="parentAndAllTask.parentTasks.length>0">
                        <span title="Save Task" class="fa-solid fa-circle-down fa-rotate-180 fa-xl"
                            data-bs-toggle="modal" attr.data-bs-target="#createTask{{modalId + 1}}"
                            (click)="onClickCreateTask(taskData, 'UPDATE', $event)" style="color: #0095a8;"></span>
                    </div>

                    <div class="col icons" *ngIf="parentAndAllTask.parentTasks.length>0">
                        <span title="Response history" class="fa-solid fa fa-history fa-xl"
                            [routerLink]="['changehistory', taskData.taskId]" style="color: blue"></span>
                    </div>
                </div>

            </td>
        </tr>

        <tr *ngIf="showChildTable.get(taskData.taskId)">
            <td colspan="9">

                <app-task-table [modalId]="modalId + taskData.taskId + 1" [parentTaskData]="taskData.childTask"
                    [employees]="employees" [allStatus]="allStatus"></app-task-table>
            </td>
        </tr>
    </ng-container>
</ng-template>


<app-create-task [modalId]="modalId + 1" [task]="emptyTask" [parentTask]="parentTask" [allEmployees]="employees"
    [allStatus]="allStatus" [updateScreen]="updateScreen" [allVisas]="allVisas" [allTaxTypes]="allTaxTypes"
    [allJobLocations]="allJobLocations" [allJobPortals]="allJobPortals"
    (afterCreateTask)="afterCreateTask()"></app-create-task>




<ng-template #nodata>
    <div class="align-right">
        <span title="Add Task" class="fa-solid fa-circle-plus fa-xl mainaddtaskbtn -mt35px" style="color: #03a300;"
            data-bs-toggle="modal" attr.data-bs-target="#createTask{{modalId + 1}}"
            (click)="onClickCreateTask(task, 'ADD', $event)"></span>
    </div>
    <h4>📋Task Creation Guide</h4>
    <div class="instructions">
        <p>Hey Task Titan! 🚀 Ready to conquer your first task? Follow these quick steps:</p>
    </div>
    <div class="step">
        <p>1. 🌟 Click the
            <span title="Add Task" class="fa-solid fa-circle-plus fa-xl " style="color: #03a300;" data-bs-toggle="modal"
                attr.data-bs-target="#createTask{{modalId + 1}}"
                (click)="onClickCreateTask(task, 'ADD', $event)"></span>
            sign in the top right corner.
        </p>
    </div>

    <div class="step">
        <p>2. ✏️ Fill in your task details</p>
    </div>

    <div class="step">
        <p>3. 🚀 Hit 'Save' like launching a rocket.</p>
    </div>